# Azure DevOps Pipeline - Personal Portfolio Copilot
# Tests only - Vercel handles deployment

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - main
      - develop

pool:
  name: 'macpool'  # OK ‚úÖ

variables:
  pythonVersion: '3.11'
  nodeVersion: '18.x'

stages:
  - stage: BackendTests
    displayName: 'Backend - Tests & Quality Checks'
    jobs:
      - job: TestBackend
        displayName: 'Test Backend'
        steps:                          # ‚Üê 6 espaces exactement
          - checkout: self
            displayName: 'Checkout repository'
          - script: |
              pwd
              ls -la
              ls -la backend/ || echo "backend/ n'existe pas"
              ls -la tests/ || echo "tests/ n'existe pas"
              python --version
              which python
            displayName: 'DIAGNOSTIC Mac'

      

  # ========================================
  # STAGE 2: FRONTEND TESTS
  # ========================================
  - stage: FrontendTests
    displayName: 'Frontend - Tests & Quality Checks'
    dependsOn: [] # Run in parallel with backend
    jobs:
      - job: TestFrontend
        displayName: 'Test Frontend'
        steps:
          # Checkout code
          - checkout: self
            displayName: 'Checkout repository'
          
          # Setup Node.js
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Use Node.js $(nodeVersion)'
          
          # Install dependencies
          - script: |
              cd frontend
              npm ci
            displayName: 'Install Node.js dependencies'
          
          # Run linting
          - script: |
              cd frontend
              npm run lint
            displayName: 'Run linting (ESLint)'
            continueOnError: true
          
          # Run unit tests
          - script: |
              cd frontend
              npm test -- --coverage --watchAll=false --ci
            displayName: 'Run frontend tests'
          
          # Publish test results (if configured)
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'frontend/coverage/junit.xml'
              failTaskOnFailedTests: false
              testRunTitle: 'Frontend Tests'
            displayName: 'Publish test results'
            condition: succeededOrFailed()
            continueOnError: true
          
          # Test production build
          - script: |
              cd frontend
              npm run build
            displayName: 'Test production build (Vercel will use this)'
          
          # Publish build artifacts (optional)
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'frontend/build'
              ArtifactName: 'frontend-build'
              publishLocation: 'Container'
            displayName: 'Publish build artifacts'
            condition: succeeded()

  # ========================================
  # STAGE 3: SECURITY SCANNING
  # ========================================
  - stage: SecurityScan
    displayName: 'Security - Dependency Scanning'
    dependsOn:
      - BackendTests
      - FrontendTests
    condition: succeeded()
    jobs:
      - job: SecurityChecks
        displayName: 'Security Checks'
        steps:
          # Checkout code
          - checkout: self
            displayName: 'Checkout repository'
          
          # Python dependency scan
          - script: |
              pip install safety
              safety check --file backend/requirements.txt --output text || true
            displayName: 'Python dependency vulnerability scan'
            continueOnError: true
          
          # Node.js dependency scan
          - script: |
              cd frontend
              npm audit --audit-level=moderate || true
            displayName: 'Node.js dependency vulnerability scan'
            continueOnError: true

  # ========================================
  # STAGE 4: BUILD SUMMARY
  # ========================================
  - stage: BuildSummary
    displayName: 'Build Summary'
    dependsOn:
      - BackendTests
      - FrontendTests
      - SecurityScan
    condition: succeededOrFailed()
    jobs:
      - job: Summary
        displayName: 'Build Summary'
        steps:
          - script: |
              echo "================================"
              echo "BUILD SUMMARY"
              echo "================================"
              echo "‚úÖ Backend tests completed"
              echo "‚úÖ Frontend tests completed"
              echo "‚úÖ Security scans completed"
              echo ""
              echo "üì¶ Next steps:"
              echo "   ‚Ä¢ Vercel will deploy frontend automatically from GitHub"
              echo "   ‚Ä¢ Deploy backend manually to your chosen platform"
              echo ""
              echo "Build ID: $(Build.BuildId)"
              echo "Build Number: $(Build.BuildNumber)"
              echo "Source Branch: $(Build.SourceBranch)"
              echo "================================"
            displayName: 'Show build summary'
